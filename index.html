<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enquetes - Poker de Quinta</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@300;400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Roboto', sans-serif;background:#0d1b0d;color:#fff;min-height:100vh}
.logo-top{text-align:center;padding:20px}
.logo-top img{max-width:200px}
.container{max-width:1000px;margin:auto;padding:20px}
header{text-align:center;background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;margin-bottom:30px}
h1{font-family:'Anton';color:#d4a121;letter-spacing:3px}
.subtitle{margin-top:10px}

.enquete-section{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:25px;margin-bottom:25px}
.enquete-section h2{font-family:'Anton';color:#d4a121;margin-bottom:20px;font-size:1.8em}

.vote-option{background:rgba(255,255,255,.05);padding:15px;border-radius:10px;margin-bottom:10px;cursor:pointer;border:2px solid transparent;transition:all 0.3s}
.vote-option:hover{border-color:#d4a121;background:rgba(212,161,33,.1)}
.vote-option.selected{border-color:#d4a121;background:rgba(212,161,33,.2)}
.option-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.option-name{font-weight:bold;font-size:1.1em}
.option-votes{color:#d4a121;font-weight:bold}
.progress-bar{background:#1a3d1a;height:8px;border-radius:4px;overflow:hidden;margin-top:8px}
.progress-fill{background:#d4a121;height:100%;transition:width 0.3s}

.form-group{margin-bottom:20px}
.form-group label{color:#d4a121;font-weight:bold;display:block;margin-bottom:8px}
.form-group select{width:100%;padding:12px;border-radius:8px;border:1px solid #2d5016;background:#1a3d1a;color:#fff;font-size:1em}

.vote-btn{width:100%;padding:15px;background:#d4a121;border:none;border-radius:10px;font-weight:bold;cursor:pointer;color:#000;font-size:1.1em;margin-top:15px}
.vote-btn:disabled{opacity:0.5;cursor:not-allowed}

.voters-list{margin-top:15px;padding-top:15px;border-top:1px solid rgba(212,161,33,.3)}
.voters-list h4{color:#d4a121;margin-bottom:10px;font-size:0.9em}
.voter-tag{display:inline-block;background:#2d5016;padding:4px 10px;border-radius:15px;margin:3px;font-size:0.85em}

.status-indicator{position:fixed;top:10px;right:10px;background:#2d5016;padding:8px 15px;border-radius:20px;font-size:0.85em;border:1px solid #d4a121}
.status-indicator.connected{background:#1a3d1a;border-color:#4CAF50}

.results-section{background:#102810;border:2px dashed #d4a121;border-radius:12px;padding:20px;margin-top:20px}
.result-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(212,161,33,.2)}
.result-item:last-child{border:none}

.dashboard{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:25px}
.dashboard-card{background:#102810;border:2px solid #d4a121;border-radius:12px;padding:20px;text-align:center}
.dashboard-card .card-icon{font-size:2.5em;margin-bottom:10px}
.dashboard-card h3{font-family:'Anton';color:#d4a121;font-size:0.9em;margin-bottom:10px;letter-spacing:1px}
.dashboard-card .card-value{font-family:'Anton';font-size:1.4em;color:#fff;margin-bottom:5px;min-height:40px}
.dashboard-card .card-detail{color:#d4a121;font-size:0.9em;opacity:0.9}

.add-btn{width:100%;padding:15px;background:#d4a121;border:none;border-radius:10px;font-weight:bold;cursor:pointer;margin-bottom:10px;color:#000}
.remove-vote-btn{background:#c72c48;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:0.85em;margin-left:5px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
.modal.active{display:flex}
.modal-content{background:#102810;border:2px solid #d4a121;border-radius:15px;padding:30px;width:90%;max-width:500px}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-btn{flex:1;padding:10px;font-weight:bold;border:none;border-radius:8px;cursor:pointer}
.modal-btn.confirm{background:#d4a121;color:#000}
.modal-btn.cancel{background:#c72c48;color:#fff}

@media(max-width:768px){
.option-header{flex-direction:column;align-items:flex-start;gap:5px}
.dashboard{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="status-indicator connected" id="statusIndicator">‚úÖ Conectado</div>

<div class="logo-top">
<img src="logo pdq.png" onerror="this.style.display='none'">
</div>

<div class="container">

<header>
<h1>ENQUETES POKER DE QUINTA</h1>
<div class="subtitle">üìä Vote nas op√ß√µes da pr√≥xima etapa</div>
</header>

<!-- DASHBOARD DE RESULTADOS -->
<div class="dashboard" id="dashboard">
<div class="dashboard-card">
<div class="card-icon">üçΩÔ∏è</div>
<h3>JANTA MAIS VOTADA</h3>
<div class="card-value" id="dashJantaVencedor">-</div>
<div class="card-detail" id="dashJantaVotos">0 votos</div>
</div>
<div class="dashboard-card">
<div class="card-icon">üé¥</div>
<h3>M√ÉO MAIS VOTADA</h3>
<div class="card-value" id="dashMaoVencedor">-</div>
<div class="card-detail" id="dashMaoVotos">0 votos</div>
</div>
<div class="dashboard-card">
<div class="card-icon">üë•</div>
<h3>PARTICIPA√á√ÉO</h3>
<div class="card-value" id="dashParticipacao">0%</div>
<div class="card-detail" id="dashTotalVotos">0/20 votantes</div>
</div>
</div>

<div class="form-group">
<label>üë§ Selecione seu nome para votar</label>
<select id="playerSelect">
<option value="">Escolha seu nome...</option>
</select>
</div>

<!-- ENQUETE 1: JANTA -->
<div class="enquete-section" id="enqueteJanta">
<h2>üçΩÔ∏è ENQUETE: JANTA</h2>
<div style="background: rgba(212, 161, 33, 0.1); border: 2px dashed #d4a121; border-radius: 10px; padding: 15px; margin-bottom: 20px;" id="avisoJanta">
<p style="margin-bottom: 10px; font-weight: bold; color: #d4a121;">üìã AGUARDANDO DEFINI√á√ÉO DAS OP√á√ïES</p>
<p style="opacity: 0.9; line-height: 1.6;">A organiza√ß√£o est√° definindo as op√ß√µes para a pr√≥xima vota√ß√£o da janta. Assim que as op√ß√µes forem definidas, voc√™ poder√° votar aqui!</p>
<p style="margin-top: 10px; font-size: 0.95em; opacity: 0.85;">‚è∞ O prazo de vota√ß√£o ser√° exibido quando as op√ß√µes estiverem dispon√≠veis.</p>
</div>

<p style="margin-bottom:20px;opacity:0.9">Escolha sua op√ß√£o preferida para a janta:</p>
<div id="jantaOptions"></div>
<button class="vote-btn" id="btnVotarJanta" disabled style="background: #666; cursor: not-allowed;">AGUARDANDO OP√á√ïES</button>
<div class="results-section" id="jantaResults" style="display:none">
<h3 style="color:#d4a121;margin-bottom:15px">üìä Resultados</h3>
<div id="jantaResultsList"></div>
</div>
</div>

<!-- ENQUETE 2: M√ÉO DA ETAPA -->
<div class="enquete-section">
<h2>üé¥ ENQUETE: M√ÉO DA ETAPA</h2>
<div style="background: rgba(212, 161, 33, 0.1); border: 2px dashed #d4a121;border-radius: 10px; padding: 15px; margin-bottom: 20px;" id="avisoMao">
<p style="margin-bottom: 10px; font-weight: bold; color: #d4a121;">üìã AGUARDANDO DEFINI√á√ÉO DAS OP√á√ïES</p>
<p style="opacity: 0.9; line-height: 1.6;">A organiza√ß√£o est√° definindo as op√ß√µes para a M√£o da Etapa. Assim que as op√ß√µes forem definidas, voc√™ poder√° votar aqui!</p>
<p style="margin-top: 10px; font-size: 0.95em; opacity: 0.85;">üé∞ A M√£o da Etapa ativa a Roleta da Sorte para pr√™mios especiais!</p>
</div>
<p style="margin-bottom:20px;opacity:0.9">Vote na sua m√£o favorita da etapa:</p>
<div id="maoOptions"></div>
<button class="vote-btn" id="btnVotarMao" disabled style="background: #666; cursor: not-allowed;">AGUARDANDO OP√á√ïES</button>
<div class="results-section" id="maoResults" style="display:none">
<h3 style="color:#d4a121;margin-bottom:15px">üìä Resultados</h3>
<div id="maoResultsList"></div>
</div>
</div>

</div>

<button class="add-btn" id="btnModoAdmin" style="position:fixed;bottom:10px;right:10px;width:auto;padding:8px 15px;background:rgba(13,27,13,0.3);border:1px solid rgba(212,161,33,0.1);opacity:0.15;font-size:0.7em;transition:opacity 0.3s">üîê</button>

<div class="modal" id="modalAdmin">
<div class="modal-content">
<h2 style="color: #8b0000;">üîê Modo Administrador</h2>
<p style="margin: 15px 0; opacity: 0.8;">Digite a senha de administrador para acessar fun√ß√µes exclusivas:</p>
<div class="form-group">
<label>Senha Admin</label>
<input type="password" id="senhaAdmin" placeholder="Digite a senha">
</div>
<div class="modal-buttons">
<button class="modal-btn cancel" id="btnFecharAdmin">Cancelar</button>
<button class="modal-btn confirm" id="btnAcessarAdmin" style="background:#8b0000; color:#fff">Acessar</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, push, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyD_XXjcjJYM73wLTTzpDgzKCOZnztcJhjE",
  authDomain: "poker-de-quinta.firebaseapp.com",
  databaseURL: "https://poker-de-quinta-default-rtdb.firebaseio.com",
  projectId: "poker-de-quinta",
  storageBucket: "poker-de-quinta.firebasestorage.app",
  messagingSenderId: "776724152456",
  appId: "1:776724152456:web:fbffde9a1c1a7628c61f3d"
};

const jogadores = ["Amarildo","Boy","Buiu","Caio","Charles","Cleversson","Davi","Gera","Diego","Dos Anjos","Eduardo","Fernando","Gregory","Gaspar","Guilherme","Guti","Igor","Izidio","Jean","Jean Rebuy","Junior","Leo","Loreto","Lucas","Matheus","Maykon","Neto","Nil","Peterson","Rafael","Ricardo Amarante","Ricardo Linhares","Ricardo Matoso","Robson","Sergio","Solano","Tigre","Van Van","Waltinho","Wesley"];

// OP√á√ïES REMOVIDAS - AGORA AS OP√á√ïES SER√ÉO CARREGADAS DO FIREBASE
let opcoesJanta = [];
let opcoesMao = [];

let db;
let votosJanta = {};
let votosMao = {};
let jantaSelecionada = null;
let maoSelecionada = null;
let jogadorAtual = null;
let modoAdmin = false;

// N√öMERO FIXO PARA C√ÅLCULO DE PARTICIPA√á√ÉO
const TOTAL_PARTICIPANTES = 20;

// FUN√á√ÉO PARA LIMPAR VOTOS DA VACA ATOLADA
async function limparVotosVacaAtolada() {
  try {
    const votosRef = ref(db, 'enquetes/janta');
    const snapshot = await get(votosRef);
    
    if (snapshot.exists()) {
      const votos = snapshot.val();
      let votosRemovidos = 0;
      
      // Encontrar e remover votos da "Vaca Atolada"
      for (let key in votos) {
        if (votos[key].opcao === "Vaca Atolada") {
          await remove(ref(db, `enquetes/janta/${key}`));
          votosRemovidos++;
          console.log(`Voto de ${votos[key].jogador} na Vaca Atolada removido`);
        }
      }
      
      if (votosRemovidos > 0) {
        console.log(`${votosRemovidos} votos da Vaca Atolada removidos com sucesso`);
      }
    }
  } catch (e) {
    console.error('Erro ao limpar votos da Vaca Atolada:', e);
  }
}

// CARREGAR OP√á√ïES DO FIREBASE
async function carregarOpcoesDoFirebase() {
  try {
    const opcoesJantaSnapshot = await get(ref(db, 'opcoes/janta'));
    const opcoesMaoSnapshot = await get(ref(db, 'opcoes/mao'));
    
    if (opcoesJantaSnapshot.exists()) {
      opcoesJanta = opcoesJantaSnapshot.val();
      console.log('Op√ß√µes de janta carregadas:', opcoesJanta);
    } else {
      // Se n√£o houver op√ß√µes no Firebase, deixar vazio
      opcoesJanta = [];
    }
    
    if (opcoesMaoSnapshot.exists()) {
      opcoesMao = opcoesMaoSnapshot.val();
      console.log('Op√ß√µes de m√£o carregadas:', opcoesMao);
    } else {
      // Se n√£o houver op√ß√µes no Firebase, deixar vazio
      opcoesMao = [];
    }
    
    // Renderizar op√ß√µes ap√≥s carregar
    renderizarOpcoes('janta');
    renderizarOpcoes('mao');
    
    // Atualizar avisos se houver op√ß√µes
    atualizarAvisosEnquetes();
  } catch (e) {
    console.error('Erro ao carregar op√ß√µes:', e);
  }
}

// ATUALIZAR AVISOS DAS ENQUETES
function atualizarAvisosEnquetes() {
  const avisoJanta = document.getElementById('avisoJanta');
  const avisoMao = document.getElementById('avisoMao');
  const btnVotarJanta = document.getElementById('btnVotarJanta');
  const btnVotarMao = document.getElementById('btnVotarMao');
  
  // Atualizar aviso da janta
  if (opcoesJanta.length > 0) {
    avisoJanta.innerHTML = `
      <p style="margin-bottom: 10px; font-weight: bold; color: #d4a121;">üçΩÔ∏è VOTA√á√ÉO DA JANTA ABERTA</p>
      <p style="opacity: 0.9; line-height: 1.6;">Escolha sua op√ß√£o preferida para a janta! Quanto mais cedo voc√™ votar, melhor ser√° a organiza√ß√£o.</p>
      <p style="margin-top: 10px; font-size: 0.95em; opacity: 0.85;">‚è∞ O prazo de vota√ß√£o ser√° exibido aqui quando definido.</p>
    `;
    btnVotarJanta.textContent = 'VOTAR NA JANTA';
    btnVotarJanta.style.background = '#d4a121';
    btnVotarJanta.style.cursor = 'pointer';
  } else {
    avisoJanta.innerHTML = `
      <p style="margin-bottom: 10px; font-weight: bold; color: #d4a121;">üìã AGUARDANDO DEFINI√á√ÉO DAS OP√á√ïES</p>
      <p style="opacity: 0.9; line-height: 1.6;">A organiza√ß√£o est√° definindo as op√ß√µes para a pr√≥xima vota√ß√£o da janta. Assim que as op√ß√µes forem definidas, voc√™ poder√° votar aqui!</p>
      <p style="margin-top: 10px; font-size: 0.95em; opacity: 0.85;">‚è∞ O prazo de vota√ß√£o ser√° exibido quando as op√ß√µes estiverem dispon√≠veis.</p>
    `;
    btnVotarJanta.textContent = 'AGUARDANDO OP√á√ïES';
    btnVotarJanta.style.background = '#666';
    btnVotarJanta.style.cursor = 'not-allowed';
  }
  
  // Atualizar aviso da m√£o
  if (opcoesMao.length > 0) {
    avisoMao.innerHTML = `
      <p style="margin-bottom: 10px; font-weight: bold; color: #d4a121;">üé∞ M√ÉO DA ETAPA - VOTA√á√ÉO ABERTA!</p>
      <p style="opacity: 0.9; line-height: 1.6;">Quem <strong>ganhar a m√£o</strong> com as cartas escolhidas e tiver <strong>showdown</strong> fica eleg√≠vel a girar a <strong>Roleta da Sorte</strong> üé° e concorrer a pr√™mios especiais!</p>
      <p style="margin-top: 10px; font-size: 0.95em; opacity: 0.85;">üìã Para mais informa√ß√µes, <a href="https://pokerdequinta.github.io/regulamento/" style="color: #d4a121; font-weight: bold; text-decoration: underline;">Leia o Regulamento</a></p>
    `;
    btnVotarMao.textContent = 'VOTAR NA M√ÉO';
    btnVotarMao.style.background = '#d4a121';
    btnVotarMao.style.cursor = 'pointer';
  } else {
    avisoMao.innerHTML = `
      <p style="margin-bottom: 10px; font-weight: bold; color: #d4a121;">üìã AGUARDANDO DEFINI√á√ÉO DAS OP√á√ïES</p>
      <p style="opacity: 0.9; line-height: 1.6;">A organiza√ß√£o est√° definindo as op√ß√µes para a M√£o da Etapa. Assim que as op√ß√µes forem definidas, voc√™ poder√° votar aqui!</p>
      <p style="margin-top: 10px; font-size: 0.95em; opacity: 0.85;">üé∞ A M√£o da Etapa ativa a Roleta da Sorte para pr√™mios especiais!</p>
    `;
    btnVotarMao.textContent = 'AGUARDANDO OP√á√ïES';
    btnVotarMao.style.background = '#666';
    btnVotarMao.style.cursor = 'not-allowed';
  }
}

try {
  const app = initializeApp(firebaseConfig);
  db = getDatabase(app);
  
  // Limpar votos da Vaca Atolada ao iniciar
  limparVotosVacaAtolada();
  
  // Carregar op√ß√µes do Firebase
  carregarOpcoesDoFirebase();
  
  // Monitorar mudan√ßas nas op√ß√µes
  onValue(ref(db, 'opcoes/janta'), () => {
    carregarOpcoesDoFirebase();
  });
  
  onValue(ref(db, 'opcoes/mao'), () => {
    carregarOpcoesDoFirebase();
  });
  
  onValue(ref(db, 'enquetes/janta'), (snapshot) => {
    votosJanta = snapshot.val() || {};
    
    // Filtrar votos da Vaca Atolada (seguran√ßa adicional)
    Object.keys(votosJanta).forEach(key => {
      if (votosJanta[key] && votosJanta[key].opcao === "Vaca Atolada") {
        delete votosJanta[key];
      }
    });
    
    renderizarOpcoes('janta');
    atualizarDashboard();
  });
  
  onValue(ref(db, 'enquetes/mao'), (snapshot) => {
    votosMao = snapshot.val() || {};
    renderizarOpcoes('mao');
    atualizarDashboard();
  });
} catch (e) {
  console.error(e);
}

// Preencher select de jogadores
const selectJogador = document.getElementById('playerSelect');
jogadores.sort().forEach(j => {
  const o = document.createElement('option');
  o.value = o.textContent = j;
  selectJogador.appendChild(o);
});

selectJogador.onchange = (e) => {
  jogadorAtual = e.target.value;
  // S√≥ habilita os bot√µes se houver op√ß√µes definidas
  btnVotarJanta.disabled = !jogadorAtual || !jantaSelecionada || opcoesJanta.length === 0;
  btnVotarMao.disabled = !jogadorAtual || !maoSelecionada || opcoesMao.length === 0;
  renderizarOpcoes('janta');
  renderizarOpcoes('mao');
};

function renderizarOpcoes(tipo) {
  const opcoes = tipo === 'janta' ? opcoesJanta : opcoesMao;
  const votos = tipo === 'janta' ? votosJanta : votosMao;
  const container = document.getElementById(tipo + 'Options');
  const resultsContainer = document.getElementById(tipo + 'Results');
  
  // Sempre esconder resultados por enquanto
  resultsContainer.style.display = 'none';
  
  // Filtrar votos da Vaca Atolada (seguran√ßa extra)
  const votosFiltrados = {};
  Object.keys(votos).forEach(key => {
    if (votos[key] && votos[key].opcao !== "Vaca Atolada") {
      votosFiltrados[key] = votos[key];
    }
  });
  
  let totalVotos = 0;
  let votosPorOpcao = {};
  let votantesPorOpcao = {};
  
  Object.values(votosFiltrados).forEach(voto => {
    totalVotos++;
    votosPorOpcao[voto.opcao] = (votosPorOpcao[voto.opcao] || 0) + 1;
    if (!votantesPorOpcao[voto.opcao]) votantesPorOpcao[voto.opcao] = [];
    votantesPorOpcao[voto.opcao].push(voto.jogador);
  });
  
  let jaVotou = false;
  let votoAnterior = null;
  Object.entries(votosFiltrados).forEach(([key, voto]) => {
    if (voto.jogador === jogadorAtual) {
      jaVotou = true;
      votoAnterior = voto.opcao;
    }
  });
  
  container.innerHTML = '';
  
  // Se n√£o houver op√ß√µes definidas
  if (opcoes.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 30px; color: #d4a121; opacity: 0.7;">
        <div style="font-size: 2.5em; margin-bottom: 15px;">‚è≥</div>
        <div style="font-weight: bold; margin-bottom: 10px; font-size: 1.2em;">Op√ß√µes ainda n√£o definidas</div>
        <div style="opacity: 0.9;">A organiza√ß√£o est√° definindo as op√ß√µes de vota√ß√£o. Em breve voc√™ poder√° votar aqui!</div>
        <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.8;">
          <strong>Como funciona:</strong> Quando as op√ß√µes forem definidas, elas aparecer√£o aqui automaticamente.
        </div>
      </div>
    `;
    return;
  }
  
  // Se houver op√ß√µes, renderizar normalmente
  opcoes.forEach(opcao => {
    // Pular Vaca Atolada se estiver na lista
    if (opcao === "Vaca Atolada") return;
    
    const numVotos = votosPorOpcao[opcao] || 0;
    const percentual = totalVotos > 0 ? (numVotos / totalVotos * 100).toFixed(1) : 0;
    const isSelected = tipo === 'janta' ? jantaSelecionada === opcao : maoSelecionada === opcao;
    const jaVotouNesta = votoAnterior === opcao;
    
    const div = document.createElement('div');
    div.className = 'vote-option' + (isSelected ? ' selected' : '');
    div.onclick = () => {
      if (!jogadorAtual) {
        alert('Selecione seu nome primeiro!');
        return;
      }
      if (tipo === 'janta') {
        jantaSelecionada = opcao;
        btnVotarJanta.disabled = false;
      } else {
        maoSelecionada = opcao;
        btnVotarMao.disabled = false;
      }
      renderizarOpcoes(tipo);
    };
    
    div.innerHTML = `
      <div class="option-header">
        <span class="option-name">${opcao} ${jaVotouNesta ? '‚úÖ' : ''}</span>
        <span class="option-votes">${numVotos} voto${numVotos !== 1 ? 's' : ''} (${percentual}%)</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${percentual}%"></div>
      </div>
      ${numVotos > 0 ? `
        <div class="voters-list">
          <h4>Votaram nesta op√ß√£o:</h4>
          ${votantesPorOpcao[opcao].map(v => {
            const votoKey = Object.keys(votosFiltrados).find(key => votosFiltrados[key].jogador === v && votosFiltrados[key].opcao === opcao);
            const btnRemover = modoAdmin ? `<button class="remove-vote-btn" onclick="removerVoto('${tipo}','${votoKey}')">‚ùå</button>` : '';
            return `<span class="voter-tag">${v}${btnRemover}</span>`;
          }).join('')}
        </div>
      ` : ''}
    `;
    
    container.appendChild(div);
  });
}

btnVotarJanta.onclick = async () => {
  if (!jogadorAtual || !jantaSelecionada) return;
  if (opcoesJanta.length === 0) {
    alert('As op√ß√µes da janta ainda n√£o foram definidas!');
    return;
  }
  
  // N√£o permitir votar na Vaca Atolada
  if (jantaSelecionada === "Vaca Atolada") {
    alert('Esta op√ß√£o n√£o est√° dispon√≠vel para vota√ß√£o.');
    return;
  }
  
  const votosRef = ref(db, 'enquetes/janta');
  const snapshot = await get(votosRef);
  if (snapshot.exists()) {
    const votos = snapshot.val();
    for (let key in votos) {
      if (votos[key].jogador === jogadorAtual) {
        await remove(ref(db, `enquetes/janta/${key}`));
      }
    }
  }
  
  await push(ref(db, 'enquetes/janta'), {
    jogador: jogadorAtual,
    opcao: jantaSelecionada,
    data: new Date().toISOString()
  });
  
  alert('Voto registrado com sucesso! N√£o Esque√ßa de Votar na M√£o da Etapa üéâ');
  jantaSelecionada = null;
  btnVotarJanta.disabled = true;
};

btnVotarMao.onclick = async () => {
  if (!jogadorAtual || !maoSelecionada) return;
  if (opcoesMao.length === 0) {
    alert('As op√ß√µes da m√£o ainda n√£o foram definidas!');
    return;
  }
  
  const votosRef = ref(db, 'enquetes/mao');
  const snapshot = await get(votosRef);
  if (snapshot.exists()) {
    const votos = snapshot.val();
    for (let key in votos) {
      if (votos[key].jogador === jogadorAtual) {
        await remove(ref(db, `enquetes/mao/${key}`));
      }
    }
  }
  
  await push(ref(db, 'enquetes/mao'), {
    jogador: jogadorAtual,
    opcao: maoSelecionada,
    data: new Date().toISOString()
  });
  
  alert('Voto registrado com sucesso! üéâ');
  maoSelecionada = null;
  btnVotarMao.disabled = true;
};

function atualizarDashboard() {
  let votosPorJanta = {};
  let votantesJanta = new Set();
  
  // Filtrar votos da Vaca Atolada no dashboard tamb√©m
  Object.values(votosJanta).forEach(voto => {
    if (voto.opcao !== "Vaca Atolada") {
      votosPorJanta[voto.opcao] = (votosPorJanta[voto.opcao] || 0) + 1;
      votantesJanta.add(voto.jogador);
    }
  });
  
  let jantaVencedor = '-';
  let jantaMaxVotos = 0;
  Object.entries(votosPorJanta).forEach(([opcao, votos]) => {
    if (votos > jantaMaxVotos) {
      jantaMaxVotos = votos;
      jantaVencedor = opcao;
    }
  });
  document.getElementById('dashJantaVencedor').textContent = jantaVencedor;
  document.getElementById('dashJantaVotos').textContent = `${jantaMaxVotos} voto${jantaMaxVotos !== 1 ? 's' : ''}`;
  document.getElementById('dashJantaVencedor').style.color = '#fff';
  document.getElementById('dashJantaVotos').style.color = '#d4a121';
  
  let votosPorMao = {};
  let votantesMao = new Set();
  Object.values(votosMao).forEach(voto => {
    votosPorMao[voto.opcao] = (votosPorMao[voto.opcao] || 0) + 1;
    votantesMao.add(voto.jogador);
  });
  
  let maoVencedor = '-';
  let maoMaxVotos = 0;
  Object.entries(votosPorMao).forEach(([opcao, votos]) => {
    if (votos > maoMaxVotos) {
      maoMaxVotos = votos;
      maoVencedor = opcao;
    }
  });
  document.getElementById('dashMaoVencedor').textContent = maoVencedor;
  document.getElementById('dashMaoVotos').textContent = `${maoMaxVotos} voto${maoMaxVotos !== 1 ? 's' : ''}`;
  
  const totalVotantes = new Set([
    ...Object.values(votosJanta).filter(v => v.opcao !== "Vaca Atolada").map(v => v.jogador),
    ...Object.values(votosMao).map(v => v.jogador)
  ]).size;
  
  // CALCULAR PARTICIPA√á√ÉO BASEADA EM 20 (n√£o no n√∫mero de jogadores)
  const participacao = TOTAL_PARTICIPANTES > 0 ? ((totalVotantes / TOTAL_PARTICIPANTES) * 100).toFixed(1) : 0;
  
  document.getElementById('dashParticipacao').textContent = `${participacao}%`;
  document.getElementById('dashTotalVotos').textContent = `${totalVotantes}/${TOTAL_PARTICIPANTES} votantes`;
}

// Fun√ß√£o para remover voto (apenas admin)
window.removerVoto = async (tipo, votoKey) => {
  if (!modoAdmin) return;
  if (!confirm('Remover este voto?')) return;
  
  try {
    await remove(ref(db, `enquetes/${tipo}/${votoKey}`));
    alert('Voto removido com sucesso!');
  } catch (e) {
    alert('Erro ao remover voto: ' + e.message);
  }
};

// Modo Admin
btnModoAdmin.onclick = () => modalAdmin.classList.add('active');
btnFecharAdmin.onclick = () => modalAdmin.classList.remove('active');
btnAcessarAdmin.onclick = () => {
  if (document.getElementById('senhaAdmin').value === "poker2026") {
    modoAdmin = true;
    modalAdmin.classList.remove('active');
    btnModoAdmin.style.background = '#4CAF50';
    btnModoAdmin.style.opacity = '1';
    alert("Modo Admin Ativado! Agora voc√™ pode remover votos.");
    renderizarOpcoes('janta');
    renderizarOpcoes('mao');
  } else {
    alert("Senha incorreta!");
  }
};

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sistema de enquetes carregado');
  console.log('Participa√ß√£o calculada sobre 20 participantes');
  console.log('Votos da Vaca Atolada foram removidos');
});

</script>
</body>

</html>
